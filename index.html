<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelişmiş KPSS Önlisans Planlayıcısı</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #1a1a2e; --surface-color: #16213e; --primary-color: #0f3460;
            --secondary-color: #e94560; --text-color: #e0e0e0; --text-muted: #a0a0a0;
            --success-color: #3dd598; --danger-color: #f7685b; --warning-color: #fca120;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-color);
            color: var(--text-color); line-height: 1.6;
        }
        .container { max-width: 1300px; margin: 0 auto; padding: 1rem; }
        nav {
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            background-color: var(--surface-color); padding: 0.5rem 1rem;
            border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: sticky; top: 1rem; z-index: 1000;
        }
        .nav-links { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; }
        .nav-link {
            padding: 0.8rem 1rem; border: none; background: none; color: var(--text-muted);
            cursor: pointer; font-size: 0.9rem; font-weight: 600; border-radius: 8px;
            transition: background-color 0.2s, color 0.2s;
        }
        .nav-link.active, .nav-link:hover { background-color: var(--secondary-color); color: white; }
        #logout-btn {
            background-color: transparent; border: 1px solid var(--secondary-color); color: var(--secondary-color);
            padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        #logout-btn:hover { background-color: var(--secondary-color); color: white; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .widget {
            background-color: var(--surface-color); border-radius: 12px;
            padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        h2 { color: white; margin-bottom: 1rem; font-size: 1.5rem; border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; }
        h3 { color: var(--text-color); margin-bottom: 1rem; font-size: 1.2rem; }
        
        /* Auth Screen */
        #auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .auth-box { background-color: var(--surface-color); padding: 2.5rem; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); text-align: center; max-width: 400px; width: 100%; }
        .auth-box h2 { border: none; }
        .auth-form input { width: 100%; padding: 0.8rem; margin-bottom: 1rem; background-color: var(--bg-color); border: 1px solid var(--primary-color); color: var(--text-color); border-radius: 5px; font-size: 1rem; }
        .auth-form button { width: 100%; padding: 0.8rem; background-color: var(--secondary-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1rem; font-weight: 600; }
        .auth-toggle-link { margin-top: 1.5rem; color: var(--text-muted); cursor: pointer; }
        .auth-toggle-link:hover { color: var(--secondary-color); }
        #auth-error { color: var(--secondary-color); margin-top: 1rem; min-height: 1.2rem; }
        #app-container { display: none; }

        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .countdown-grid { display: grid; grid-template-columns: repeat(4, 1fr); text-align: center; }
        .countdown-item { font-size: 2rem; font-weight: 700; } .countdown-item span { display: block; font-size: 0.8rem; color: var(--text-muted); }

        /* Konu Takibi */
        .subject-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .subject-card { background-color: var(--primary-color); padding: 1rem; border-radius: 8px; }
        .subject-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .subject-header h3 { margin-bottom: 0; }
        .toggle-icon { font-size: 2rem; font-weight: 300; line-height: 1; }
        .subject-card progress { width: 100%; margin: 0.5rem 0; accent-color: var(--secondary-color); }
        .topic-list { list-style: none; padding-left: 0.5rem; max-height: 250px; overflow-y: auto; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out, margin 0.4s ease-in-out; margin-top: 0.5rem; }
        .topic-list.collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; overflow: hidden; }
        .topic-list label { display: flex; align-items: center; cursor: pointer; }
        .topic-list input[type="checkbox"] { margin-right: 0.8rem; }
        .topic-list input:checked + span { text-decoration: line-through; color: var(--text-muted); }

        /* Generic Forms & Tables */
        .data-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end; }
        .data-form input, .data-form select, .data-form textarea { width: 100%; padding: 0.5rem; background-color: var(--bg-color); border: 1px solid var(--primary-color); color: var(--text-color); border-radius: 5px; }
        .data-form button { background-color: var(--secondary-color); color: white; border: none; padding: 0.8rem; border-radius: 5px; cursor: pointer; grid-column: 1 / -1; }
        .history-table-container { width: 100%; overflow-x: auto; margin-top: 1.5rem; }
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th, .history-table td { padding: 0.8rem; text-align: center; border: 1px solid var(--primary-color); }
        .history-table th { background-color: var(--primary-color); }
        .history-table .delete-btn, .history-table .details-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; }
        .history-table .delete-btn { color: var(--danger-color); }
        .history-table .details-btn { color: var(--success-color); }

        /* Pomodoro Timer */
        #pomodoro-timer { text-align: center; }
        #pomodoro-display { font-size: 6rem; font-weight: 700; margin: 2rem 0; }
        #pomodoro-controls button { background-color: var(--primary-color); color: white; border: none; padding: 1rem 2rem; margin: 0 0.5rem; border-radius: 8px; font-size: 1rem; cursor: pointer; }
        #pomodoro-controls button:hover { background-color: var(--secondary-color); }

        /* Toast & Modal */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast { background-color: var(--surface-color); color: var(--text-color); padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); margin-bottom: 1rem; opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards; border-left: 5px solid; }
        .toast.success { border-left-color: var(--success-color); } .toast.error { border-left-color: var(--danger-color); }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        .empty-state { text-align: center; color: var(--text-muted); padding: 2rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 3000; }
        .modal-content { background-color: var(--surface-color); padding: 2rem; border-radius: 12px; width: 90%; max-width: 600px; position: relative; }
        .modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        
        /* Haftalık Plan - DÜZENLENDİ */
        .weekly-plan-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .daily-task-list { list-style: none; padding: 0; min-height: 150px; }
        .daily-task-list li { display: flex; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background-color: var(--bg-color); border-radius: 5px;}
        .daily-task-list input[type="checkbox"] { margin-right: 10px; }
        .daily-task-list span { flex-grow: 1; }
        .daily-task-list input:checked + span { text-decoration: line-through; color: var(--text-muted); }
        .add-task-form { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .add-task-form input { flex-grow: 1; }
        .add-task-form button { padding: 0.5rem; background-color: var(--secondary-color); border:none; color:white; border-radius: 5px; cursor: pointer;}
        
        /* Ayarlar - DÜZENLENDİ */
        .settings-form button { width: 100%; display: block; margin-bottom: 0.5rem; padding: 0.8rem; border: none; color: white; border-radius: 5px; cursor: pointer; font-weight: 600;}
        #save-settings { background-color: var(--success-color); }
        #export-data-btn { background-color: var(--primary-color); }
        #import-data-btn-trigger { background-color: var(--primary-color); }
        #reset-data-btn { background-color: var(--danger-color); }

    </style>
</head>
<body>
    <div id="auth-container">
        <div class="auth-box">
            <div id="login-view">
                <h2>Giriş Yap</h2>
                <form id="login-form" class="auth-form">
                    <input type="text" id="login-username" placeholder="Kullanıcı Adı" required>
                    <input type="password" id="login-password" placeholder="Şifre" required>
                    <button type="submit">Giriş Yap</button>
                </form>
                <p id="auth-error"></p>
                <p class="auth-toggle-link" id="show-register-view">Hesabın yok mu? Kayıt ol.</p>
            </div>
            <div id="register-view" style="display:none;">
                <h2>Kayıt Ol</h2>
                <form id="register-form" class="auth-form">
                    <input type="text" id="register-username" placeholder="Kullanıcı Adı" required>
                    <input type="password" id="register-password" placeholder="Şifre" required>
                    <button type="submit">Kayıt Ol</button>
                </form>
                <p class="auth-toggle-link" id="show-login-view">Zaten hesabın var mı? Giriş yap.</p>
            </div>
        </div>
    </div>

    <div id="app-container" class="container">
        <nav>
            <div class="nav-links">
                <button class="nav-link active" data-target="dashboard-page">Ana Sayfa</button>
                <button class="nav-link" data-target="konu-takip-page">Konu Takibi</button>
                <button class="nav-link" data-target="deneme-analiz-page">Deneme Analizi</button>
                <button class="nav-link" data-target="soru-takip-page">Soru Takibi</button>
                <button class="nav-link" data-target="yanlis-defteri-page">Yanlış Defterim</button>
                <button class="nav-link" data-target="pomodoro-page">Pomodoro</button>
                <button class="nav-link" data-target="haftalik-plan-page">Haftalık Plan</button>
                <button class="nav-link" data-target="ayarlar-page">Ayarlar</button>
            </div>
            <button id="logout-btn">Çıkış Yap</button>
        </nav>

        <main>
            <section id="dashboard-page" class="page active">
                <div class="dashboard-grid">
                    <div id="countdown" class="widget">
                        <h2>Sınava Kalan Süre</h2>
                        <div class="countdown-grid">
                            <div class="countdown-item"><div id="days">00</div><span>Gün</span></div>
                            <div class="countdown-item"><div id="hours">00</div><span>Saat</span></div>
                            <div class="countdown-item"><div id="minutes">00</div><span>Dakika</span></div>
                            <div class="countdown-item"><div id="seconds">00</div><span>Saniye</span></div>
                        </div>
                    </div>
                    <div class="widget">
                        <h2>Genel İlerleme</h2>
                        <div style="text-align:center; padding:1rem;">
                            <progress id="overall-progress" value="0" max="100" style="width:100%; height:20px; accent-color: var(--success-color);"></progress>
                            <p id="overall-progress-text" style="font-size:1.5rem; font-weight:bold; margin-top:0.5rem;">0%</p>
                        </div>
                    </div>
                    <div class="widget">
                        <h2>Son Deneme</h2>
                        <div id="last-deneme-summary" class="empty-state">Henüz deneme çözülmedi.</div>
                    </div>
                    <div class="widget">
                        <h2>Günün Mottosu</h2>
                        <p id="quote" style="margin-top: 1rem; font-style: italic; color: var(--text-muted); text-align:center; font-size: 1.1rem;"></p>
                    </div>
                    <div class="widget" style="grid-column: 1 / -1;">
                        <h2>Bugünkü Görevler</h2>
                        <input type="text" id="todo-input" placeholder="Yeni görev ekle ve Enter'a bas..." style="width: 100%; padding: 0.5rem; background-color: var(--bg-color); border: 1px solid var(--primary-color); color: var(--text-color); border-radius: 5px; margin-bottom: 1rem;">
                        <ul id="todo-list" style="list-style: none;"></ul>
                    </div>
                </div>
            </section>

            <section id="konu-takip-page" class="page">
                <h2>Konu Takip Çizelgesi</h2>
                <div class="subject-grid"></div>
            </section>

            <section id="deneme-analiz-page" class="page">
                <div class="widget">
                    <h2>Yeni Deneme Ekle</h2>
                    <form id="deneme-form" class="data-form"></form>
                </div>
                <div class="widget">
                    <h2>Net Grafiği</h2>
                    <div id="deneme-chart-container">
                        <canvas id="deneme-chart"></canvas>
                    </div>
                </div>
                <div class="widget">
                    <h2>Deneme Geçmişi</h2>
                    <div id="deneme-history-container" class="history-table-container"></div>
                </div>
            </section>
            
            <section id="soru-takip-page" class="page">
                 <div class="widget">
                    <h2>Günlük Soru Sayısı Ekle</h2>
                    <form id="soru-takip-form" class="data-form">
                        <div>
                            <label for="soru-tarih">Tarih:</label>
                            <input type="date" id="soru-tarih" required>
                        </div>
                        <div>
                            <label for="soru-ders">Ders:</label>
                            <select id="soru-ders" required></select>
                        </div>
                        <div>
                            <label for="soru-sayisi">Çözülen Soru:</label>
                            <input type="number" id="soru-sayisi" placeholder="Örn: 50" min="1" required>
                        </div>
                         <div>
                            <label for="soru-dogru">Doğru Sayısı:</label>
                            <input type="number" id="soru-dogru" placeholder="Örn: 45" min="0" required>
                        </div>
                        <button type="submit">Kaydet</button>
                    </form>
                </div>
                <div class="widget">
                    <h2>Soru Geçmişi</h2>
                    <div id="soru-history-container" class="history-table-container"></div>
                </div>
            </section>

            <section id="yanlis-defteri-page" class="page">
                <div class="widget">
                    <h2>Yanlış Soru Ekle</h2>
                    <form id="yanlis-form" class="data-form">
                        <div style="grid-column: 1 / -1;"><label>Ders:</label><select id="yanlis-ders" required></select></div>
                        <div style="grid-column: 1 / -1;"><label>Konu:</label><input type="text" id="yanlis-konu" placeholder="Örn: Osmanlı Yükselme Dönemi" required></div>
                        <div style="grid-column: 1 / -1;"><label>Notlar / Doğru Çözüm:</label><textarea id="yanlis-notlar" rows="4" placeholder="Soruyu neden yanlış yaptığınızı veya doğrusunun ne olduğunu yazın..."></textarea></div>
                        <button type="submit">Yanlışı Kaydet</button>
                    </form>
                </div>
                <div class="widget">
                    <h2>Hata Defterim</h2>
                    <div id="yanlis-history-container" class="history-table-container"></div>
                </div>
            </section>
            
            <section id="pomodoro-page" class="page">
                <div class="widget">
                    <h2>Pomodoro Zamanlayıcı</h2>
                    <div id="pomodoro-timer">
                        <div id="pomodoro-display">25:00</div>
                        <div id="pomodoro-status" style="margin-bottom: 1rem; font-weight: 600; color: var(--warning-color);">Çalışma Zamanı</div>
                        <div id="pomodoro-controls">
                            <button id="pomodoro-start">Başlat</button>
                            <button id="pomodoro-pause">Duraklat</button>
                            <button id="pomodoro-reset">Sıfırla</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="haftalik-plan-page" class="page">
                <h2>Haftalık Çalışma Planı</h2>
                <div class="weekly-plan-grid"></div>
            </section>
            
            <section id="ayarlar-page" class="page">
                <div class="widget">
                    <h2>Ayarlar</h2>
                    <div class="settings-form">
                        <h3>Sınav Tarihi</h3>
                        <label for="exam-date">KPSS Sınav Tarihini Ayarla:</label>
                        <input type="date" id="exam-date" style="width: 100%; margin-bottom: 0.5rem; padding: 0.5rem;">
                        <button id="save-settings">Tarihi Kaydet</button>
                        
                        <hr style="margin: 1.5rem 0; border-color: var(--primary-color);">

                        <h3>Veri Yönetimi</h3>
                        <button id="export-data-btn">Verileri Dışa Aktar (.json)</button>
                        <button id="import-data-btn-trigger">Verileri İçe Aktar (.json)</button>
                        <input type="file" id="import-file-input" accept=".json" style="display: none;">
                        
                        <hr style="margin: 1.5rem 0; border-color: var(--primary-color);">

                        <h3>Tehlikeli Alan</h3>
                        <button id="reset-data-btn">Tüm Verileri Sıfırla</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="deneme-details-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2 id="modal-title">Deneme Detayları</h2>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close">&times;</button>
            <h2 id="confirm-modal-title">Emin misiniz?</h2>
            <p id="confirm-modal-text">Bu işlem geri alınamaz.</p>
            <div style="text-align: right; margin-top: 1.5rem;">
                <button id="confirm-modal-cancel" style="background-color: var(--text-muted); border:none; padding: 0.5rem 1rem; border-radius: 5px; color: white; cursor: pointer;">İptal</button>
                <button id="confirm-modal-confirm" style="background-color: var(--danger-color); margin-left: 0.5rem; border:none; padding: 0.5rem 1rem; border-radius: 5px; color: white; cursor: pointer;">Onayla</button>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- GLOBAL ELEMENTS & STATE ---
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const loginView = document.getElementById('login-view');
    const registerView = document.getElementById('register-view');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const authError = document.getElementById('auth-error');
    const logoutBtn = document.getElementById('logout-btn');

    let userDatabase = JSON.parse(localStorage.getItem('kpssO_userDatabase_v2')) || {};
    let currentUser = sessionStorage.getItem('kpssO_currentUser_v2');
    let denemeChartInstance = null;
    
    const kpssData = {
        'Türkçe': { q: 30, topics: ['Sözcükte Anlam', 'Cümlede Anlam', 'Paragraf', 'Yazım Kuralları', 'Noktalama İşaretleri', 'Ses Bilgisi', 'Yapı Bilgisi', 'Sözcük Türleri', 'Cümlenin Öğeleri', 'Cümle Türleri', 'Anlatım Bozuklukları', 'Sözel Mantık'] },
        'Matematik': { q: 30, topics: ['Temel Kavramlar', 'Sayılar', 'Bölme ve Bölünebilme', 'OBEB-OKEK', 'Rasyonel Sayılar', 'Basit Eşitsizlikler', 'Mutlak Değer', 'Üslü ve Köklü Sayılar', 'Çarpanlara Ayırma', 'Oran-Orantı', 'Denklem Çözme', 'Problemler', 'Kümeler', 'İşlem ve Modüler Aritmetik', 'Permütasyon ve Olasılık', 'Sayısal Mantık', 'Geometri'] },
        'Tarih': { q: 27, topics: ['İslamiyet Öncesi Türk Tarihi', 'İlk Müslüman Türk Devletleri', 'Osmanlı Kuruluş ve Yükselme', 'Osmanlı Kültür ve Medeniyeti', 'Osmanlı Duraklama ve Gerileme', 'Osmanlı Dağılma', '20. Yüzyılda Osmanlı', 'Kurtuluş Savaşı Hazırlık', 'Kurtuluş Savaşı Muharebeler', 'İnkılaplar', 'Atatürk Dönemi İç ve Dış Politika', 'Çağdaş Türk ve Dünya Tarihi'] },
        'Coğrafya': { q: 18, topics: ['Türkiye\'nin Coğrafi Konumu', 'Türkiye\'nin Yer Şekilleri ve İklimi', 'Türkiye\'de Nüfus ve Yerleşme', 'Tarım ve Hayvancılık', 'Madenler ve Enerji Kaynakları', 'Sanayi ve Ticaret', 'Ulaşım ve Turizm', 'Bölgeler Coğrafyası'] },
        'Vatandaşlık': { q: 15, topics: ['Temel Hukuk Kavramları', 'Anayasa Hukukuna Giriş', 'Yasama', 'Yürütme', 'Yargı', 'İdare Hukuku', 'İnsan Hakları'] }
    };
    
    // --- HELPER FUNCTIONS ---
    const saveDatabase = () => localStorage.setItem('kpssO_userDatabase_v2', JSON.stringify(userDatabase));
    
    const showToast = (message, type = 'success') => {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    };
    
    const showConfirmModal = (title, text, onConfirm) => {
        const modal = document.getElementById('confirm-modal');
        modal.querySelector('#confirm-modal-title').textContent = title;
        modal.querySelector('#confirm-modal-text').textContent = text;
        modal.style.display = 'flex';

        const confirmBtn = modal.querySelector('#confirm-modal-confirm');
        const cancelBtn = modal.querySelector('#confirm-modal-cancel');
        const closeBtn = modal.querySelector('.modal-close');

        const confirmHandler = () => {
            onConfirm();
            cleanup();
        };

        const cleanup = () => {
            modal.style.display = 'none';
            confirmBtn.removeEventListener('click', confirmHandler);
            cancelBtn.removeEventListener('click', cleanup);
            closeBtn.removeEventListener('click', cleanup);
            modal.removeEventListener('click', outsideClickHandler);
        };
        
        const outsideClickHandler = (e) => {
            if (e.target === modal) cleanup();
        }

        confirmBtn.addEventListener('click', confirmHandler, { once: true });
        cancelBtn.addEventListener('click', cleanup, { once: true });
        closeBtn.addEventListener('click', cleanup, { once: true });
        modal.addEventListener('click', outsideClickHandler);
    };


    // --- AUTHENTICATION ---
    document.getElementById('show-register-view').addEventListener('click', () => {
        loginView.style.display = 'none'; registerView.style.display = 'block'; authError.textContent = '';
    });
    document.getElementById('show-login-view').addEventListener('click', () => {
        registerView.style.display = 'none'; loginView.style.display = 'block'; authError.textContent = '';
    });

    registerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('register-username').value.trim();
        const password = document.getElementById('register-password').value;
        if (userDatabase[username]) {
            authError.textContent = 'Bu kullanıcı adı zaten alınmış.'; return;
        }
        userDatabase[username] = {
            password: password, 
            settings: { examDate: '2026-09-06' },
            topicProgress: {}, denemeHistory: [], weeklyPlan: {},
            todos: {}, soruHistory: [], yanlisDefteri: []
        };
        saveDatabase();
        showToast('Kayıt başarılı! Şimdi giriş yapabilirsiniz.');
        document.getElementById('show-login-view').click();
    });

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;
        if (userDatabase[username] && userDatabase[username].password === password) {
            sessionStorage.setItem('kpssO_currentUser_v2', username);
            currentUser = username;
            initializeApp();
        } else {
            authError.textContent = 'Kullanıcı adı veya şifre hatalı.';
        }
    });

    logoutBtn.addEventListener('click', () => {
        sessionStorage.removeItem('kpssO_currentUser_v2');
        currentUser = null;
        authContainer.style.display = 'flex';
        appContainer.style.display = 'none';
        if (denemeChartInstance) {
            denemeChartInstance.destroy();
        }
    });

    // --- MAIN APP INITIALIZATION ---
    function initializeApp() {
        if (!currentUser) {
            authContainer.style.display = 'flex'; appContainer.style.display = 'none'; return;
        }
        authContainer.style.display = 'none'; appContainer.style.display = 'block';

        let userData = userDatabase[currentUser];
        if (!userData.yanlisDefteri) userData.yanlisDefteri = [];
        if (!userData.soruHistory) userData.soruHistory = [];
        if (!userData.weeklyPlan) userData.weeklyPlan = {};


        const saveData = () => { userDatabase[currentUser] = userData; saveDatabase(); };

        // --- NAVIGATION ---
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                pages.forEach(page => page.classList.toggle('active', page.id === link.dataset.target));
            });
        });

        // --- DASHBOARD ---
        const renderDashboard = () => {
            const allTopics = Object.values(kpssData).flatMap(d => d.topics);
            const totalTopicCount = allTopics.length;
            const completedTopicCount = Object.values(userData.topicProgress).filter(Boolean).length;
            const overallProgress = totalTopicCount > 0 ? Math.round((completedTopicCount / totalTopicCount) * 100) : 0;
            document.getElementById('overall-progress').value = overallProgress;
            document.getElementById('overall-progress-text').textContent = `${overallProgress}% Tamamlandı`;

            const lastDenemeDiv = document.getElementById('last-deneme-summary');
            if (userData.denemeHistory.length > 0) {
                const lastDeneme = userData.denemeHistory[userData.denemeHistory.length - 1];
                lastDenemeDiv.innerHTML = `<h3 style="border:none; margin-bottom:0.5rem;">${lastDeneme.name}</h3><p><strong>Toplam Net:</strong> ${lastDeneme.totalNet.toFixed(2)}</p><p><small>Tarih: ${lastDeneme.date}</small></p>`;
                lastDenemeDiv.classList.remove('empty-state');
            } else {
                lastDenemeDiv.innerHTML = 'Henüz deneme çözülmedi.';
                lastDenemeDiv.classList.add('empty-state');
            }
        };

        // --- SETTINGS (GELİŞTİRİLDİ) ---
        const examDateInput = document.getElementById('exam-date');
        examDateInput.value = userData.settings.examDate;
        document.getElementById('save-settings').addEventListener('click', () => {
            userData.settings.examDate = examDateInput.value;
            saveData();
            showToast("Sınav tarihi kaydedildi.");
            startCountdown();
        });

        document.getElementById('export-data-btn').addEventListener('click', () => {
            const dataStr = JSON.stringify(userData);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kpss_planner_backup_${currentUser}_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("Veriler dışa aktarıldı.");
        });

        const importFileInput = document.getElementById('import-file-input');
        document.getElementById('import-data-btn-trigger').addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    // Basic validation
                    if (importedData.settings && importedData.topicProgress) {
                        showConfirmModal(
                            'Verileri İçe Aktar',
                            'Mevcut verilerinizin üzerine yazılacaktır. Bu işlem geri alınamaz. Emin misiniz?',
                            () => {
                                userDatabase[currentUser] = importedData;
                                saveData();
                                showToast("Veriler başarıyla içe aktarıldı. Sayfa yenileniyor...");
                                setTimeout(() => location.reload(), 1500);
                            }
                        );
                    } else {
                        showToast("Geçersiz veya bozuk yedek dosyası.", "error");
                    }
                } catch (err) {
                    showToast("Dosya okunurken bir hata oluştu.", "error");
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // Reset file input
        });

        document.getElementById('reset-data-btn').addEventListener('click', () => {
            showConfirmModal(
                'Tüm Verileri Sıfırla',
                'Tüm konu ilerlemeniz, deneme geçmişiniz ve planlarınız kalıcı olarak silinecektir. Emin misiniz?',
                () => {
                    userDatabase[currentUser] = {
                        ...userDatabase[currentUser], // keep password
                        settings: { examDate: '2026-09-06' }, topicProgress: {}, denemeHistory: [], 
                        weeklyPlan: {}, todos: {}, soruHistory: [], yanlisDefteri: []
                    };
                    saveData();
                    showToast("Tüm veriler sıfırlandı. Sayfa yenileniyor...", "error");
                    setTimeout(() => location.reload(), 1500);
                }
            );
        });

        // --- COUNTDOWN ---
        let countdownInterval;
        const startCountdown = () => {
            clearInterval(countdownInterval);
            const kpssExamDate = new Date(`${userData.settings.examDate}T10:15:00`).getTime();
            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = kpssExamDate - now;
                if (distance < 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdown').innerHTML = "<h2>Başarılar!</h2>"; return;
                }
                document.getElementById('days').innerText = String(Math.floor(distance / (1000 * 60 * 60 * 24))).padStart(2, '0');
                document.getElementById('hours').innerText = String(Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))).padStart(2, '0');
                document.getElementById('minutes').innerText = String(Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))).padStart(2, '0');
                document.getElementById('seconds').innerText = String(Math.floor((distance % (1000 * 60)) / 1000)).padStart(2, '0');
            }, 1000);
        };

        // --- TODO LIST ---
        const todoInput = document.getElementById('todo-input');
        const todoList = document.getElementById('todo-list');
        const todayStr = new Date().toISOString().slice(0, 10);
        if (!userData.todos[todayStr]) userData.todos[todayStr] = [];
        let todos = userData.todos[todayStr];
        const renderTodos = () => {
            todoList.innerHTML = '';
            todos.forEach((todo, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<label style="display:flex; align-items:center; cursor:pointer; flex-grow:1;"><input type="checkbox" ${todo.completed ? 'checked' : ''} style="margin-right:10px;"><span>${todo.text}</span></label><button class="delete-btn" style="background:none; color: var(--danger-color);">&times;</button>`;
                li.style.display = 'flex'; li.style.alignItems = 'center'; li.style.marginBottom = '5px';
                if (todo.completed) li.querySelector('span').style.textDecoration = 'line-through';
                li.querySelector('input').addEventListener('change', () => {
                    todos[index].completed = !todos[index].completed; saveAndRenderTodos();
                });
                li.querySelector('button').addEventListener('click', () => {
                    todos.splice(index, 1); saveAndRenderTodos();
                });
                todoList.appendChild(li);
            });
        };
        const saveAndRenderTodos = () => { userData.todos[todayStr] = todos; saveData(); renderTodos(); };
        todoInput.addEventListener('keypress', e => {
            if (e.key === 'Enter' && todoInput.value.trim()) {
                todos.push({ text: todoInput.value, completed: false });
                todoInput.value = ''; saveAndRenderTodos();
            }
        });

        // --- MOTIVATIONAL QUOTE ---
        const quotes = ["Başarının sırrı, başlamaktır.", "Bugünün tekrarı, yarının netidir.", "Unutma, her net bir adımdır.", "En büyük zafer, hiç düşmemek değil, her düştüğünde kalkabilmektir."];
        document.getElementById('quote').textContent = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;

        // --- KONU TAKIBI ---
        const subjectGrid = document.querySelector('#konu-takip-page .subject-grid');
        subjectGrid.innerHTML = '';
        Object.keys(kpssData).forEach(subject => {
            const card = document.createElement('div');
            card.className = 'subject-card';
            const topicListHTML = kpssData[subject].topics.map((topic, index) => `<li<label><input type="checkbox" data-id="${subject}-${index}" ${userData.topicProgress[`${subject}-${index}`] ? 'checked' : ''}><span>${topic}</span></label></li>`).join('');
            card.innerHTML = `<div class="subject-header"><h3>${subject}</h3><span class="toggle-icon">+</span></div><progress value="0" max="100"></progress><p class="progress-text">0%</p><ul class="topic-list collapsed">${topicListHTML}</ul>`;
            subjectGrid.appendChild(card);
        });
        const updateProgress = () => {
            Object.keys(kpssData).forEach(subject => {
                const topics = kpssData[subject].topics;
                const checkedCount = topics.filter((t, i) => userData.topicProgress[`${subject}-${i}`]).length;
                const progress = topics.length > 0 ? Math.round((checkedCount / topics.length) * 100) : 0;
                const card = [...subjectGrid.children].find(c => c.querySelector('h3').textContent === subject);
                if (card) {
                    card.querySelector('progress').value = progress;
                    card.querySelector('.progress-text').textContent = `${progress}% tamamlandı.`;
                }
            });
            renderDashboard();
        };
        subjectGrid.addEventListener('click', e => {
            const header = e.target.closest('.subject-header'); if (!header) return;
            const list = header.parentElement.querySelector('.topic-list');
            const icon = header.parentElement.querySelector('.toggle-icon');
            list.classList.toggle('collapsed');
            icon.textContent = list.classList.contains('collapsed') ? '+' : '−';
        });
        subjectGrid.addEventListener('change', e => {
            if (e.target.type === 'checkbox') {
                userData.topicProgress[e.target.dataset.id] = e.target.checked;
                saveData(); updateProgress();
            }
        });
        
        // --- DENEME ANALIZI ---
        const denemeForm = document.getElementById('deneme-form');
        const denemeHistoryContainer = document.getElementById('deneme-history-container');
        const denemeModal = document.getElementById('deneme-details-modal');
        let denemeFormHTML = `<div><label for="deneme-adi">Deneme Adı/No:</label><input type="text" id="deneme-adi" required></div>`;
        const gyDersler = ['Türkçe', 'Matematik'];
        const gkDersler = ['Tarih', 'Coğrafya', 'Vatandaşlık'];
        denemeFormHTML += `<fieldset style="border:1px solid var(--primary-color); padding:1rem; border-radius:8px;"><legend>Genel Yetenek</legend>`;
        gyDersler.forEach(ders => { denemeFormHTML += `<label>${ders} (${kpssData[ders].q} Soru) (D/Y/B):</label><div style="display:flex; gap:5px; margin-bottom:0.5rem;"><input type="number" class="deneme-input" data-ders="${ders}" placeholder="D" min="0" max="${kpssData[ders].q}"><input type="number" class="deneme-input" data-ders="${ders}" placeholder="Y" min="0" max="${kpssData[ders].q}"><input type="number" class="deneme-input" data-ders="${ders}" placeholder="B" min="0" max="${kpssData[ders].q}"></div>`; });
        denemeFormHTML += `</fieldset><fieldset style="border:1px solid var(--primary-color); padding:1rem; border-radius:8px;"><legend>Genel Kültür</legend>`;
        gkDersler.forEach(ders => { denemeFormHTML += `<label>${ders} (${kpssData[ders].q} Soru) (D/Y/B):</label><div style="display:flex; gap:5px; margin-bottom:0.5rem;"><input type="number" class="deneme-input" data-ders="${ders}" placeholder="D" min="0" max="${kpssData[ders].q}"><input type="number" class="deneme-input" data-ders="${ders}" placeholder="Y" min="0" max="${kpssData[ders].q}"><input type="number" class="deneme-input" data-ders="${ders}" placeholder="B" min="0" max="${kpssData[ders].q}"></div>`; });
        denemeFormHTML += `</fieldset><button type="submit">Denemeyi Kaydet</button>`;
        denemeForm.innerHTML = denemeFormHTML;
        const renderDenemeHistory = () => { /* ... unchanged ... */ };
        const renderDenemeChart = () => { /* ... unchanged ... */ };
        denemeForm.addEventListener('submit', (e) => { /* ... unchanged ... */ });
        denemeHistoryContainer.addEventListener('click', (e) => { /* ... unchanged ... */ });
        denemeModal.querySelector('.modal-close').addEventListener('click', () => denemeModal.style.display = 'none');
        denemeModal.addEventListener('click', (e) => { if(e.target === denemeModal) denemeModal.style.display = 'none'; });

        // --- SORU TAKİBİ ---
        const soruForm = document.getElementById('soru-takip-form');
        const soruTarihInput = document.getElementById('soru-tarih');
        const soruDersSelect = document.getElementById('soru-ders');
        const soruHistoryContainer = document.getElementById('soru-history-container');
        soruTarihInput.valueAsDate = new Date();
        soruDersSelect.innerHTML = Object.keys(kpssData).map(ders => `<option value="${ders}">${ders}</option>`).join('');
        const renderSoruHistory = () => { /* ... unchanged ... */ };
        soruForm.addEventListener('submit', e => { /* ... unchanged ... */ });
        soruHistoryContainer.addEventListener('click', e => { /* ... unchanged ... */ });

        // --- YANLIŞ DEFTERİ ---
        const yanlisForm = document.getElementById('yanlis-form');
        const yanlisDersSelect = document.getElementById('yanlis-ders');
        const yanlisHistoryContainer = document.getElementById('yanlis-history-container');
        yanlisDersSelect.innerHTML = Object.keys(kpssData).map(ders => `<option value="${ders}">${ders}</option>`).join('');
        const renderYanlisDefteri = () => { /* ... unchanged ... */ };
        yanlisForm.addEventListener('submit', e => { /* ... unchanged ... */ });
        yanlisHistoryContainer.addEventListener('click', e => { /* ... unchanged ... */ });
        
        // --- POMODORO TIMER ---
        const display = document.getElementById('pomodoro-display');
        const status = document.getElementById('pomodoro-status');
        const startBtn = document.getElementById('pomodoro-start');
        const pauseBtn = document.getElementById('pomodoro-pause');
        const resetBtn = document.getElementById('pomodoro-reset');
        let timerInterval; let timeLeft = 25 * 60; let isPaused = true; let isWorkSession = true;
        const updateDisplay = () => { /* ... unchanged ... */ };
        const playSound = () => { /* ... unchanged ... */ };
        const startTimer = () => { /* ... unchanged ... */ };
        const pauseTimer = () => { /* ... unchanged ... */ };
        const resetTimer = () => { /* ... unchanged ... */ };
        startBtn.addEventListener('click', startTimer); pauseBtn.addEventListener('click', pauseTimer); resetBtn.addEventListener('click', resetTimer);

        // --- HAFTALIK PLAN (GELİŞTİRİLDİ) ---
        const weeklyPlanGrid = document.querySelector('#haftalik-plan-page .weekly-plan-grid');
        const days = ['Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi', 'Pazar'];
        
        const renderWeeklyPlan = () => {
            weeklyPlanGrid.innerHTML = '';
            days.forEach(day => {
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card widget';
                dayCard.dataset.day = day;

                // Backward compatibility: if data is a string, convert to new object format
                if (typeof userData.weeklyPlan[day] === 'string') {
                    userData.weeklyPlan[day] = userData.weeklyPlan[day].split('\n').filter(t => t.trim() !== '').map(text => ({ text, completed: false }));
                }
                
                if (!Array.isArray(userData.weeklyPlan[day])) {
                    userData.weeklyPlan[day] = [];
                }

                const tasks = userData.weeklyPlan[day];
                const taskListHTML = tasks.map((task, index) => `
                    <li data-index="${index}">
                        <input type="checkbox" ${task.completed ? 'checked' : ''}>
                        <span>${task.text}</span>
                        <button class="delete-btn" style="background:none; color: var(--danger-color);">&times;</button>
                    </li>
                `).join('');

                dayCard.innerHTML = `
                    <h3>${day}</h3>
                    <ul class="daily-task-list">${taskListHTML}</ul>
                    <form class="add-task-form">
                        <input type="text" placeholder="Yeni görev..." required>
                        <button type="submit">Ekle</button>
                    </form>`;
                weeklyPlanGrid.appendChild(dayCard);
            });
        };

        weeklyPlanGrid.addEventListener('submit', e => {
            e.preventDefault();
            if (e.target.classList.contains('add-task-form')) {
                const input = e.target.querySelector('input[type="text"]');
                const day = e.target.closest('.day-card').dataset.day;
                if (input.value.trim()) {
                    userData.weeklyPlan[day].push({ text: input.value.trim(), completed: false });
                    saveData();
                    renderWeeklyPlan();
                }
            }
        });
        
        weeklyPlanGrid.addEventListener('click', e => {
            if (e.target.classList.contains('delete-btn')) {
                const day = e.target.closest('.day-card').dataset.day;
                const index = e.target.closest('li').dataset.index;
                userData.weeklyPlan[day].splice(index, 1);
                saveData();
                renderWeeklyPlan();
            }
        });

        weeklyPlanGrid.addEventListener('change', e => {
            if (e.target.type === 'checkbox') {
                const day = e.target.closest('.day-card').dataset.day;
                const index = e.target.closest('li').dataset.index;
                userData.weeklyPlan[day][index].completed = e.target.checked;
                saveData();
                // No need to re-render for checkbox, just apply style
                const span = e.target.nextElementSibling;
                if (e.target.checked) {
                    span.style.textDecoration = 'line-through';
                    span.style.color = 'var(--text-muted)';
                } else {
                    span.style.textDecoration = 'none';
                    span.style.color = 'var(--text-color)';
                }
            }
        });

        // --- INITIAL RENDERS ---
        startCountdown();
        renderTodos();
        updateProgress();
        // renderDenemeHistory(); // These are now part of the functions they belong to
        // renderDenemeChart();
        // renderSoruHistory();
        // renderYanlisDefteri();
        renderDashboard();
        // updateDisplay();
        renderWeeklyPlan();

        // Re-call functions that might have been skipped on init
        const initRenders = () => {
            Object.values(document.querySelectorAll('.history-table-container')).forEach(el => {
                if(el.innerHTML === '') {
                    if(el.id === 'deneme-history-container') renderDenemeHistory();
                    if(el.id === 'soru-history-container') renderSoruHistory();
                    if(el.id === 'yanlis-history-container') renderYanlisDefteri();
                }
            });
            renderDenemeChart();
            updateDisplay();
        };
        initRenders();
    }
    
    initializeApp();
});
</script>
</body>
</html>

